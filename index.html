<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <!-- (واحدة فقط) -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>سلة الفواكه</title>
  <link rel="icon" href="favicon.ico?v=1" type="image/x-icon" />

  <style>
    :root { color-scheme: light dark; }
    html, body {
      margin: 0; padding: 0;
      height: 100%; width: 100%;
      background: #000; overflow: hidden;
    }

    /* الحاوية: تمركز + استخدام dvh لتقليل قفزات iOS */
    #unity-container {
      position: fixed; inset: 0;
      display: flex; align-items: center; justify-content: center;
      background: #000;
      height: 100dvh; /* يدعم iOS/Safari */
    }

    /* سيُعاد ضبط الحجم عبر السكربت؛ لا تحدد خصائص width/height على العنصر نفسه */
    #unity-canvas {
      display: block;
      background: #231F20;
      transform-origin: center center;
      width: 100%;
      height: 100%;
      image-rendering: auto;
    }

    /* شريط التحميل */
    #unity-loading-bar {
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
      z-index: 10;
      pointer-events: none;
    }
    #unity-logo1 {
      width: 40vw; max-width: 280px; height: auto;
    }
    #unity-progress-bar {
      width: 764px; max-width: 90vw; height: 40px;
      background: url('bar.png') no-repeat center / 100% 100%;
      position: relative; overflow: hidden;
      border-radius: 10px;
      transform: scale(0.7);
      transform-origin: top center;
    }
    #unity-progress-bar-fill {
      position: absolute; top: 7px; left: 6px;
      height: calc(100% - 14px);
      width: 0%;
      background: #55CAC2;
      transition: width .3s ease;
      border-radius: 20px 0 0 20px;
    }
    @media (max-width: 768px) {
      #unity-logo1 { width: 50vw; max-width: 200px; }
      #unity-progress-bar { width: 550px; height: 30px; margin-top: 0; }
      #unity-progress-bar-fill { border-radius: 5px 0 0 5px; }
    }
  </style>
</head>

<body>
  <div id="unity-container">
    <!-- لا تضع خصائص width/height هنا -->
    <canvas id="unity-canvas" tabindex="-1"></canvas>

    <div id="unity-loading-bar">
      <img id="unity-logo1" src="logo1.png" alt="Loading Logo" />
      <div id="unity-progress-bar">
        <div id="unity-progress-bar-fill"></div>
      </div>
    </div>
  </div>

  <!-- سكربت ضبط المقاس (واحد فقط) -->
  <script>
    (function () {
      const TARGET_ASPECT = 16 / 9;

      function isMobile() {
        return /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
      }
      function vw() {
        return (window.visualViewport ? Math.floor(window.visualViewport.width) : window.innerWidth);
      }
      function vh() {
        return Math.floor(window.visualViewport ? window.visualViewport.height : window.innerHeight);
      }
      function isPortrait() { return vh() >= vw(); }

      function layout() {
        const canvas = document.getElementById('unity-canvas');
        if (!canvas) return;

        // Desktop: Letterbox للحفاظ على 16:9
        if (!isMobile()) {
          const W = vw(), H = vh();
          const aspect = W / H;
          let drawW, drawH;
          if (aspect > TARGET_ASPECT) { drawH = H; drawW = Math.round(drawH * TARGET_ASPECT); }
          else { drawW = W; drawH = Math.round(drawW / TARGET_ASPECT); }
          canvas.style.width = drawW + 'px';
          canvas.style.height = drawH + 'px';
          canvas.style.transform = '';
          return;
        }

        // Mobile:
        if (isPortrait()) {
          // طلبك: املأ العرض والارتفاع بالكامل في البورتريه
          canvas.style.width = vw() + 'px';
          canvas.style.height = vh() + 'px';
          canvas.style.transform = '';
        } else {
          // Landscape: الحفاظ على 16:9 (Letterbox إن لزم)
          const W = vw(), H = vh();
          const aspect = W / H;
          let drawW, drawH;
          if (aspect > TARGET_ASPECT) { drawH = H; drawW = Math.round(drawH * TARGET_ASPECT); }
          else { drawW = W; drawH = Math.round(drawW / TARGET_ASPECT); }
          canvas.style.width = drawW + 'px';
          canvas.style.height = drawH + 'px';
          canvas.style.transform = '';
        }
      }

      // جدولة آمنة لتقليل الـLayout Thrash
      let scheduled = false;
      function schedule() {
        if (scheduled) return;
        scheduled = true;
        requestAnimationFrame(function () { scheduled = false; layout(); });
      }

      window.addEventListener('load', schedule, { passive: true });
      window.addEventListener('resize', schedule, { passive: true });
      window.addEventListener('orientationchange', schedule, { passive: true });
      if (window.visualViewport) {
        visualViewport.addEventListener('resize', schedule, { passive: true });
        visualViewport.addEventListener('scroll', schedule, { passive: true });
      }

      // تشغيل أولي
      layout();
    })();
  </script>

  <!-- تحميل الـUnity -->
  <script>
    window.addEventListener("load", function () {
      const canvas = document.querySelector("#unity-canvas");
      const loadingBar = document.querySelector("#unity-loading-bar");
      const progressBarFill = document.querySelector("#unity-progress-bar-fill");

      const buildUrl = "Build";
      const loaderUrl = buildUrl + "/Build.loader.js";

      const config = {
        dataUrl: buildUrl + "/Build.data.unityweb",
        frameworkUrl: buildUrl + "/Build.framework.js.unityweb",
        codeUrl: buildUrl + "/Build.wasm.unityweb",
        streamingAssetsUrl: "StreamingAssets",
        companyName: "AQTAR",
        productName: "البرتقالة الذكية",
        productVersion: "1.0",
        // مهم جداً: خلّي حجم الـWebGL يطابق حجم الـCanvas الذي يضبطه السكربت
        matchWebGLToCanvasSize: true,
        // لتقليل الحمل على الموبايل ومنع تشوهات عند DPR عالي
        devicePixelRatio: Math.min(2, window.devicePixelRatio || 1),
      };

      loadingBar.style.display = "flex";

      const script = document.createElement("script");
      script.src = loaderUrl;
      script.onload = () => {
        createUnityInstance(canvas, config, (progress) => {
          progressBarFill.style.width = (progress * 100) + "%";
        }).then(() => {
          loadingBar.style.display = "none";
        }).catch((message) => {
          alert("Unity load failed: " + message);
        });
      };
      document.body.appendChild(script);

      // الدخول ملء الشاشة عند أول تفاعل فقط (أضمن للموبايل)
      function enterFSOnce() {
        const elem = document.documentElement;
        if (!document.fullscreenElement) {
          (elem.requestFullscreen ||
            elem.webkitRequestFullscreen ||
            elem.msRequestFullscreen ||
            function () { }).call(elem);
        }
        window.removeEventListener('touchstart', enterFSOnce);
        window.removeEventListener('click', enterFSOnce);
      }
      window.addEventListener('touchstart', enterFSOnce, { once: true });
      window.addEventListener('click', enterFSOnce, { once: true });
    });
  </script>
</body>
</html>
